{% extends "base.html" %}

{% block title %}{{ project.name }} - ContextGrid{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <div class="breadcrumb">
            <a href="/projects">‚Üê Back to Projects</a>
        </div>
        <div class="project-title-section">
            <h1>{{ project.name }}</h1>
            <span class="badge badge-{{ project.status }} large">{{ project.status }}</span>
        </div>
        {% if project.progress is defined and project.progress is not none %}
        <div class="progress-bar-container detail-progress">
            <div class="progress-bar-track">
                <div class="progress-bar-fill" style="width: {{ project.progress }}%"></div>
            </div>
            <span class="progress-bar-label">{{ project.progress }}%</span>
        </div>
        {% endif %}
    </div>
    <div class="header-actions">
        <a href="/projects/{{ project.id }}/edit" class="btn btn-secondary">Edit Project</a>
        <form method="post" action="/projects/{{ project.id }}/delete" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this project? This cannot be undone.');">
            <button type="submit" class="btn btn-danger">Delete Project</button>
        </form>
    </div>
</div>

<div class="detail-grid">
    <div class="detail-main">
        {% if project.description %}
        <section class="section">
            <h2>Description</h2>
            <p>{{ project.description }}</p>
        </section>
        {% endif %}
        
        <section class="section">
            <h2>Metadata</h2>
            <table class="metadata-table">
                {% if project.project_type %}
                <tr>
                    <td class="label">Type</td>
                    <td>{{ project.project_type }}</td>
                </tr>
                {% endif %}
                {% if project.primary_language %}
                <tr>
                    <td class="label">Language</td>
                    <td>{{ project.primary_language }}</td>
                </tr>
                {% endif %}
                {% if project.stack %}
                <tr>
                    <td class="label">Stack</td>
                    <td>{{ project.stack }}</td>
                </tr>
                {% endif %}
                {% if project.scope_size %}
                <tr>
                    <td class="label">Scope</td>
                    <td>{{ project.scope_size }}</td>
                </tr>
                {% endif %}
                {% if project.learning_goal %}
                <tr>
                    <td class="label">Learning Goal</td>
                    <td>{{ project.learning_goal }}</td>
                </tr>
                {% endif %}
            </table>
        </section>
        
        {% if project.local_path or project.repo_url %}
        <section class="section">
            <h2>Location</h2>
            <table class="metadata-table">
                {% if project.repo_url %}
                <tr>
                    <td class="label">Repository</td>
                    <td><a href="{{ project.repo_url }}" target="_blank">{{ project.repo_url }}</a></td>
                </tr>
                {% endif %}
                {% if project.local_path %}
                <tr>
                    <td class="label">Local Path</td>
                    <td><code>{{ project.local_path }}</code></td>
                </tr>
                {% endif %}
            </table>
        </section>
        {% endif %}
        
        <!-- Future Ideas Section -->
        <section class="future-ideas-section">
            <div class="future-ideas-header">
                <h2><span class="future-ideas-icon">üí°</span> Future Development Ideas</h2>
            </div>
            <p style="color: var(--color-text-secondary); margin-bottom: var(--space-lg); font-size: 0.95rem;">
                Capture your ideas for future enhancements, features, or improvements for this project.
            </p>
            
            <div class="future-ideas-add-form">
                <textarea 
                    id="future-idea-input" 
                    placeholder="What's your idea for improving this project? Be as detailed or brief as you like..."
                    rows="3"
                ></textarea>
                <div class="future-ideas-form-actions">
                    <button type="button" class="btn btn-secondary btn-compact" onclick="clearFutureIdea()">Clear</button>
                    <button type="button" class="btn btn-primary btn-compact" onclick="addFutureIdea()">Add Idea</button>
                </div>
            </div>
            
            <div id="future-ideas-list" class="future-ideas-list">
                <!-- Future ideas will be loaded here -->
            </div>
        </section>
        
        {% if notes %}
        <section class="section">
            <h2>Notes</h2>
            <div class="notes-list">
                {% for note in notes %}
                <div class="note-card note-{{ note.note_type }}">
                    <div class="note-header">
                        <span class="note-type-badge">
                            {% if note.note_type == 'log' %}üìã
                            {% elif note.note_type == 'idea' %}üí°
                            {% elif note.note_type == 'blocker' %}üöß
                            {% elif note.note_type == 'reflection' %}ü§î
                            {% endif %}
                            {{ note.note_type }}
                        </span>
                        <span class="note-date">{{ note.created_at[:19] }}</span>
                    </div>
                    <div class="note-content">{{ note.content }}</div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}
        
        {% if screenshots %}
        <section class="section">
            <h2>Screenshots</h2>
            <div class="screenshots-main-display">
                {% for shot in screenshots %}
                <figure class="screenshot-large">
                    <a href="{{ shot.url }}" target="_blank" rel="noopener">
                        <img src="{{ shot.url }}" alt="{{ shot.label or 'Screenshot' }}" loading="lazy">
                    </a>
                    {% if shot.label %}
                    <figcaption>{{ shot.label }}</figcaption>
                    {% endif %}
                </figure>
                {% endfor %}
            </div>
        </section>
        {% endif %}
    </div>
    
    <div class="detail-sidebar">
        <section class="section">
            <h3>Tags</h3>
            {% if tags %}
            <div class="tag-list">
                {% for tag in tags %}
                <a href="/projects?tag={{ tag }}" class="tag">{{ tag }}</a>
                {% endfor %}
            </div>
            {% else %}
            <p class="muted">No tags</p>
            {% endif %}
        </section>

        <section class="section">
            <div class="section-header">
                <h3>Screenshots</h3>
                {% if screenshots %}
                <span class="muted">{{ screenshots | length }}</span>
                {% endif %}
            </div>

            <div style="margin-bottom: 1rem;">
                <form action="/projects/{{ project.id }}/screenshots" method="post" enctype="multipart/form-data" style="display: flex; gap: 0.5rem;">
                    <input type="file" name="file" accept="image/*" required class="form-control" style="padding: 0.4rem;">
                    <button type="submit" class="btn btn-primary" style="padding: 0.4rem 1rem; font-size: 0.9rem;">Upload</button>
                </form>
            </div>

            {% if screenshots %}
            <div class="screenshot-grid">
                {% for shot in screenshots %}
                <figure class="screenshot-card">
                    <a class="screenshot-link" href="{{ shot.url }}" target="_blank" rel="noopener">
                        <img src="{{ shot.url }}" alt="{{ shot.label or 'Screenshot' }}" loading="lazy" decoding="async">
                    </a>
                    {% if shot.label %}
                    <figcaption>{{ shot.label }}</figcaption>
                    {% endif %}
                    <form action="/projects/{{ project.id }}/screenshots/{{ shot.filename }}/delete" method="post" style="margin-top: 0.5rem;">
                        <button type="submit" class="btn btn-danger btn-compact" onclick="return confirm('Delete this screenshot?')">Delete</button>
                    </form>
                </figure>
                {% endfor %}
            </div>
            {% else %}
            <p class="muted">No screenshots yet.</p>
            {% endif %}
        </section>

        <section class="section">
            <div class="section-header">
                <h3>Relationships</h3>
                <button type="button" class="btn btn-secondary btn-compact" id="add-relationship-btn">+ Add</button>
            </div>

            <div id="relationships-list" class="relationships-list">
                <div class="relationships-loading">Loading...</div>
            </div>

            <!-- Add Relationship Modal -->
            <div id="relationship-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <h3>Add Relationship</h3>
                    <form id="relationship-form">
                        <div class="form-group">
                            <label for="target-project">Target Project</label>
                            <select id="target-project" class="form-control" required>
                                <option value="">Select a project...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="relationship-type">Relationship Type</label>
                            <select id="relationship-type" class="form-control" required>
                                <option value="related_to">Related To</option>
                                <option value="depends_on">Depends On</option>
                                <option value="part_of">Part Of</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Add Relationship</button>
                            <button type="button" class="btn btn-secondary" id="close-modal">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="section-header">
                <h3>Related Projects</h3>
                <a href="/graph" class="btn btn-link btn-compact">View Full Graph</a>
            </div>
            <div id="mini-graph" class="mini-graph-container">
                <div class="graph-loading">Loading graph...</div>
            </div>
        </section>

        <section class="section">
            <h3>Timestamps</h3>
            <table class="metadata-table small">
                <tr>
                    <td class="label">Created</td>
                    <td>{{ project.created_at[:10] }}</td>
                </tr>
                {% if project.last_worked_at %}
                <tr>
                    <td class="label">Last Viewed</td>
                    <td>{{ project.last_worked_at[:10] }}</td>
                </tr>
                {% endif %}
            </table>
        </section>
    </div>
</div>

<!-- vis.js Network via CDN for mini-graph -->
<script type="text/javascript" src="https://unpkg.com/vis-network@9.1.9/dist/vis-network.min.js"></script>

<script>
(() => {
    const projectId = {{ project.id }};
    const apiBase = '{{ api_base_url }}';

    const statusColors = {
        'active': '#10B981',
        'idea': '#F59E0B',
        'paused': '#6B7280',
        'archived': '#9CA3AF'
    };

    const edgeColors = {
        'depends_on': '#3B82F6',
        'related_to': '#8B5CF6',
        'part_of': '#10B981',
        'shared_tags': '#9CA3AF',
        'same_language': '#6B7280'
    };

    const relationshipLabels = {
        'depends_on': 'depends on',
        'related_to': 'related to',
        'part_of': 'part of'
    };

    // Detect theme
    const isDarkTheme = () => {
        return document.documentElement.getAttribute('data-theme') === 'dark';
    };

    const getThemeColors = () => {
        if (isDarkTheme()) {
            return {
                background: '#121826',
                text: '#F3F4F6',
                border: '#263041'
            };
        }
        return {
            background: '#FFFFFF',
            text: '#111827',
            border: '#E5E7EB'
        };
    };

    // ========================
    // Relationships List
    // ========================
    const relationshipsList = document.getElementById('relationships-list');
    const addRelationshipBtn = document.getElementById('add-relationship-btn');
    const relationshipModal = document.getElementById('relationship-modal');
    const closeModalBtn = document.getElementById('close-modal');
    const relationshipForm = document.getElementById('relationship-form');
    const targetProjectSelect = document.getElementById('target-project');

    async function loadRelationships() {
        try {
            const response = await fetch(`${apiBase}/api/projects/${projectId}/relationships`);
            if (!response.ok) throw new Error('Failed to fetch relationships');

            const data = await response.json();
            renderRelationships(data.relationships);
        } catch (error) {
            console.error('Error loading relationships:', error);
            relationshipsList.innerHTML = '<p class="muted">Failed to load relationships</p>';
        }
    }

    function renderRelationships(relationships) {
        if (relationships.length === 0) {
            relationshipsList.innerHTML = '<p class="muted">No relationships yet</p>';
            return;
        }

        let html = '';
        relationships.forEach(rel => {
            const label = relationshipLabels[rel.relationship_type] || rel.relationship_type;
            const directionIcon = rel.direction === 'outgoing' ? '‚Üí' : '‚Üê';

            html += `
                <div class="relationship-item">
                    <div class="relationship-info">
                        <span class="relationship-type">${label}</span>
                        <span class="relationship-direction">${directionIcon}</span>
                        <a href="/projects/${rel.target_project_id}" class="relationship-target">${escapeHtml(rel.target_project_name)}</a>
                    </div>
                    <button type="button" class="relationship-delete" data-id="${rel.id}" title="Remove relationship">√ó</button>
                </div>
            `;
        });

        relationshipsList.innerHTML = html;

        // Attach delete handlers
        relationshipsList.querySelectorAll('.relationship-delete').forEach(btn => {
            btn.addEventListener('click', async () => {
                const relId = btn.dataset.id;
                if (confirm('Remove this relationship?')) {
                    try {
                        const response = await fetch(`${apiBase}/api/relationships/${relId}`, {
                            method: 'DELETE'
                        });
                        if (response.ok) {
                            loadRelationships();
                            loadMiniGraph();
                        }
                    } catch (error) {
                        console.error('Error deleting relationship:', error);
                    }
                }
            });
        });
    }

    // Modal handling
    addRelationshipBtn.addEventListener('click', async () => {
        // Load projects for dropdown
        try {
            const response = await fetch(`${apiBase}/api/projects?limit=100`);
            const data = await response.json();

            targetProjectSelect.innerHTML = '<option value="">Select a project...</option>';
            data.projects.forEach(p => {
                if (p.id !== projectId) {
                    targetProjectSelect.innerHTML += `<option value="${p.id}">${escapeHtml(p.name)}</option>`;
                }
            });
        } catch (error) {
            console.error('Error loading projects:', error);
        }

        relationshipModal.style.display = 'flex';
    });

    closeModalBtn.addEventListener('click', () => {
        relationshipModal.style.display = 'none';
    });

    relationshipModal.addEventListener('click', (e) => {
        if (e.target === relationshipModal) {
            relationshipModal.style.display = 'none';
        }
    });

    relationshipForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const targetId = parseInt(targetProjectSelect.value);
        const relType = document.getElementById('relationship-type').value;

        if (!targetId) {
            alert('Please select a target project');
            return;
        }

        try {
            const response = await fetch(`${apiBase}/api/projects/${projectId}/relationships`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    target_project_id: targetId,
                    relationship_type: relType
                })
            });

            if (response.ok) {
                relationshipModal.style.display = 'none';
                loadRelationships();
                loadMiniGraph();
            } else {
                const err = await response.json();
                alert(err.detail || 'Failed to create relationship');
            }
        } catch (error) {
            console.error('Error creating relationship:', error);
            alert('Failed to create relationship');
        }
    });

    // ========================
    // Mini Graph
    // ========================
    const miniGraphContainer = document.getElementById('mini-graph');
    let miniNetwork = null;

    async function loadMiniGraph() {
        try {
            const response = await fetch(`${apiBase}/api/projects/${projectId}/graph?include_inferred=true`);
            if (!response.ok) throw new Error('Failed to fetch graph data');

            const data = await response.json();

            if (data.nodes.length <= 1) {
                miniGraphContainer.innerHTML = '<p class="muted" style="text-align: center; padding: 2rem 0;">No related projects found</p>';
                return;
            }

            renderMiniGraph(data);
        } catch (error) {
            console.error('Error loading mini graph:', error);
            miniGraphContainer.innerHTML = '<p class="muted">Failed to load graph</p>';
        }
    }

    function renderMiniGraph(data) {
        const themeColors = getThemeColors();

        const nodes = new vis.DataSet(data.nodes.map(node => ({
            id: node.id,
            label: node.label,
            color: {
                background: node.id === projectId
                    ? '#3B82F6'  // Highlight current project
                    : (statusColors[node.status] || '#9CA3AF'),
                border: node.id === projectId ? '#1D4ED8' : themeColors.border,
                highlight: {
                    background: node.id === projectId ? '#3B82F6' : (statusColors[node.status] || '#9CA3AF'),
                    border: '#3B82F6'
                }
            },
            font: {
                color: themeColors.text,
                size: node.id === projectId ? 14 : 12
            },
            size: node.id === projectId ? 25 : 15,
            borderWidth: node.id === projectId ? 3 : 2
        })));

        const edges = new vis.DataSet(data.edges.map((edge, idx) => ({
            id: idx,
            from: edge.source,
            to: edge.target,
            color: {
                color: edgeColors[edge.relationship_type] || '#9CA3AF',
                highlight: '#3B82F6'
            },
            dashes: edge.is_inferred,
            arrows: edge.relationship_type === 'depends_on' ? { to: { enabled: true, scaleFactor: 0.6 } } : undefined,
            width: edge.is_inferred ? 1 : 2
        })));

        const options = {
            nodes: {
                shape: 'dot',
                borderWidth: 2
            },
            edges: {
                smooth: { type: 'continuous' }
            },
            physics: {
                enabled: true,
                stabilization: {
                    iterations: 100
                },
                barnesHut: {
                    gravitationalConstant: -2000,
                    springLength: 100,
                    springConstant: 0.05
                }
            },
            interaction: {
                hover: true,
                zoomView: false,
                dragView: true
            }
        };

        miniGraphContainer.innerHTML = '';
        miniNetwork = new vis.Network(miniGraphContainer, { nodes, edges }, options);

        miniNetwork.on('click', function(params) {
            if (params.nodes.length > 0) {
                const nodeId = params.nodes[0];
                if (nodeId !== projectId) {
                    window.location.href = `/projects/${nodeId}`;
                }
            }
        });

        miniNetwork.on('stabilizationIterationsDone', function() {
            miniNetwork.setOptions({ physics: { enabled: false } });
            miniNetwork.fit({ animation: { duration: 300 } });
        });
    }

    // HTML escape utility
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Initialize
    loadRelationships();
    loadMiniGraph();

    // Theme change listener
    const themeToggle = document.getElementById('theme-toggle');
    if (themeToggle) {
        themeToggle.addEventListener('click', () => {
            setTimeout(loadMiniGraph, 100);
        });
    }
})();

// ========================
// Future Ideas Management
// ========================
(function() {
    const projectId = {{ project.id }};
    const apiBase = '{{ api_base_url }}';
    const futureIdeasList = document.getElementById('future-ideas-list');
    const futureIdeaInput = document.getElementById('future-idea-input');

    // Load future ideas
    async function loadFutureIdeas() {
        try {
            const response = await fetch(`${apiBase}/api/projects/${projectId}/notes`);
            if (!response.ok) throw new Error('Failed to fetch notes');
            
            const data = await response.json();
            // Filter for future_idea type notes
            const futureIdeas = data.notes.filter(note => note.note_type === 'future_idea');
            
            renderFutureIdeas(futureIdeas);
        } catch (error) {
            console.error('Error loading future ideas:', error);
            futureIdeasList.innerHTML = '<div class="future-ideas-empty"><p>Failed to load ideas</p></div>';
        }
    }

    // Render future ideas
    function renderFutureIdeas(ideas) {
        if (ideas.length === 0) {
            futureIdeasList.innerHTML = `
                <div class="future-ideas-empty">
                    <div class="future-ideas-empty-icon">üí≠</div>
                    <p>No future ideas yet. Start by adding your first idea above!</p>
                </div>
            `;
            return;
        }

        let html = '';
        ideas.forEach(idea => {
            const date = new Date(idea.created_at);
            const formattedDate = date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            html += `
                <div class="future-idea-card" data-id="${idea.id}">
                    <div class="future-idea-header">
                        <div class="future-idea-meta">
                            <span class="future-idea-icon">üí°</span>
                            <span class="future-idea-date">${formattedDate}</span>
                        </div>
                        <div class="future-idea-actions">
                            <button type="button" class="future-idea-action-btn" onclick="editFutureIdea(${idea.id})" title="Edit">
                                ‚úèÔ∏è Edit
                            </button>
                            <button type="button" class="future-idea-action-btn delete" onclick="deleteFutureIdea(${idea.id})" title="Delete">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                    <div class="future-idea-content" id="content-${idea.id}">
                        ${escapeHtml(idea.content)}
                    </div>
                    <div class="future-idea-edit-form" id="edit-form-${idea.id}">
                        <textarea id="edit-textarea-${idea.id}" rows="3">${escapeHtml(idea.content)}</textarea>
                        <div class="future-idea-edit-actions">
                            <button type="button" class="btn btn-secondary btn-compact" onclick="cancelEditFutureIdea(${idea.id})">Cancel</button>
                            <button type="button" class="btn btn-primary btn-compact" onclick="saveFutureIdea(${idea.id})">Save</button>
                        </div>
                    </div>
                </div>
            `;
        });

        futureIdeasList.innerHTML = html;
    }

    // Add future idea
    window.addFutureIdea = async function() {
        const content = futureIdeaInput.value.trim();
        if (!content) {
            alert('Please enter an idea before adding.');
            return;
        }

        try {
            const response = await fetch(`${apiBase}/api/projects/${projectId}/notes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    content: content,
                    note_type: 'future_idea'
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to add idea');
            }

            futureIdeaInput.value = '';
            loadFutureIdeas();
        } catch (error) {
            console.error('Error adding future idea:', error);
            alert('Failed to add idea: ' + error.message);
        }
    };

    // Clear input
    window.clearFutureIdea = function() {
        futureIdeaInput.value = '';
        futureIdeaInput.focus();
    };

    // Edit future idea
    window.editFutureIdea = function(ideaId) {
        const contentDiv = document.getElementById(`content-${ideaId}`);
        const editForm = document.getElementById(`edit-form-${ideaId}`);
        
        if (contentDiv && editForm) {
            contentDiv.style.display = 'none';
            editForm.classList.add('active');
        }
    };

    // Cancel edit
    window.cancelEditFutureIdea = function(ideaId) {
        const contentDiv = document.getElementById(`content-${ideaId}`);
        const editForm = document.getElementById(`edit-form-${ideaId}`);
        
        if (contentDiv && editForm) {
            contentDiv.style.display = 'block';
            editForm.classList.remove('active');
        }
    };

    // Save edited idea
    window.saveFutureIdea = async function(ideaId) {
        const textarea = document.getElementById(`edit-textarea-${ideaId}`);
        const newContent = textarea.value.trim();
        
        if (!newContent) {
            alert('Idea content cannot be empty.');
            return;
        }

        try {
            const response = await fetch(`${apiBase}/api/notes/${ideaId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    content: newContent,
                    note_type: 'future_idea'
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to update idea');
            }

            loadFutureIdeas();
        } catch (error) {
            console.error('Error updating future idea:', error);
            alert('Failed to update idea: ' + error.message);
        }
    };

    // Delete future idea
    window.deleteFutureIdea = async function(ideaId) {
        if (!confirm('Are you sure you want to delete this idea? This cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`${apiBase}/api/notes/${ideaId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to delete idea');
            }

            loadFutureIdeas();
        } catch (error) {
            console.error('Error deleting future idea:', error);
            alert('Failed to delete idea: ' + error.message);
        }
    };

    // HTML escape utility (reuse from parent scope or redefine)
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Initialize
    loadFutureIdeas();
})();
</script>
{% endblock %}
