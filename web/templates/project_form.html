{% extends "base.html" %}

{% block title %}New Project - ContextGrid{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Create New Project</h1>
    <p class="subtitle">Add a new project to your tracker</p>
</div>

{% if error %}
<div class="error-message">
    <strong>Error:</strong> {{ error }}
</div>
{% endif %}

<form action="/projects/new" method="post" class="project-form">
    <!-- Template Picker -->
    <div class="form-section" id="template-picker-section">
        <h2>Start from a Template <span class="muted" style="font-weight:400; font-size:0.9rem;">(optional)</span></h2>
        <div style="display:flex; gap:0.75rem; align-items:center; flex-wrap:wrap;">
            <select id="template-select" class="form-control" style="max-width:320px;">
                <option value="">‚Äî No template ‚Äî</option>
            </select>
            <button type="button" class="btn btn-secondary btn-compact" id="apply-template-btn" disabled>Apply Template</button>
            <a href="/templates" class="btn btn-link btn-compact" style="font-size:0.85rem;">Manage Templates ‚Üí</a>
        </div>
        <p id="template-description" class="muted" style="margin-top:0.5rem; font-size:0.9rem; display:none;"></p>
    </div>

    <div class="form-section">
        <h2>Basic Information</h2>

        
        <div class="form-group">
            <label for="name" class="required">Project Name</label>
            <input 
                type="text" 
                id="name" 
                name="name" 
                value="{{ form_data.name or '' }}" 
                required
                class="form-control"
                placeholder="Enter project name"
            >
        </div>
        
        <div class="form-group">
            <label for="description">Description</label>
            <textarea 
                id="description" 
                name="description" 
                rows="3"
                class="form-control"
                placeholder="Brief description of the project"
            >{{ form_data.description or '' }}</textarea>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="status">Status</label>
                <select id="status" name="status" class="form-control">
                    <option value="idea" {% if form_data.status == 'idea' or not form_data.status %}selected{% endif %}>üí° Idea</option>
                    <option value="active" {% if form_data.status == 'active' %}selected{% endif %}>üöÄ Active</option>
                    <option value="paused" {% if form_data.status == 'paused' %}selected{% endif %}>‚è∏Ô∏è Paused</option>
                    <option value="archived" {% if form_data.status == 'archived' %}selected{% endif %}>üì¶ Archived</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="project_type">Project Type</label>
                <select id="project_type" name="project_type" class="form-control">
                    <option value="">Select type...</option>
                    <option value="web" {% if form_data.project_type == 'web' %}selected{% endif %}>Web</option>
                    <option value="cli" {% if form_data.project_type == 'cli' %}selected{% endif %}>CLI</option>
                    <option value="school" {% if form_data.project_type == 'school' %}selected{% endif %}>School</option>
                    <option value="homelab" {% if form_data.project_type == 'homelab' %}selected{% endif %}>Homelab</option>
                    <option value="desktop" {% if form_data.project_type == 'desktop' %}selected{% endif %}>Desktop App</option>
                    <option value="llm-integrated" {% if form_data.project_type == 'llm-integrated' %}selected{% endif %}>LLM-integrated</option>
                    <option value="other" {% if form_data.project_type == 'other' %}selected{% endif %}>Other</option>
                </select>
            </div>
        </div>
    </div>
    
    <div class="form-section">
        <h2>Technical Details</h2>
        
        <div class="form-row">
            <div class="form-group">
                <label for="primary_language">Primary Language</label>
                <input 
                    type="text" 
                    id="primary_language" 
                    name="primary_language" 
                    value="{{ form_data.primary_language or '' }}"
                    class="form-control"
                    placeholder="e.g., Python, JavaScript, Go"
                >
            </div>
            
            <div class="form-group">
                <label for="scope_size">Scope Size</label>
                <select id="scope_size" name="scope_size" class="form-control">
                    <option value="">Select scope...</option>
                    <option value="tiny" {% if form_data.scope_size == 'tiny' %}selected{% endif %}>Tiny</option>
                    <option value="medium" {% if form_data.scope_size == 'medium' %}selected{% endif %}>Medium</option>
                    <option value="long-haul" {% if form_data.scope_size == 'long-haul' %}selected{% endif %}>Long-haul</option>
                </select>
            </div>
        </div>
        
        <div class="form-group">
            <label for="stack">Stack/Technology</label>
            <input 
                type="text" 
                id="stack" 
                name="stack" 
                value="{{ form_data.stack or '' }}"
                class="form-control"
                placeholder="e.g., FastAPI + SQLite, React + Node.js"
            >
        </div>
    </div>
    
    <div class="form-section">
        <h2>Location</h2>
        
        <div class="form-group">
            <label for="repo_url">Repository URL</label>
            <input 
                type="text" 
                id="repo_url" 
                name="repo_url" 
                value="{{ form_data.repo_url or '' }}"
                class="form-control"
                placeholder="https://github.com/username/repo"
            >
            <small class="form-help">Must start with http://, https://, or git@</small>
        </div>
    </div>
    
    <div class="form-section">
        <h2>Learning & Goals</h2>

        <div class="form-group">
            <label for="learning_goal">Learning Goal</label>
            <textarea
                id="learning_goal"
                name="learning_goal"
                rows="3"
                class="form-control"
                placeholder="What are you trying to learn or achieve with this project?"
            >{{ form_data.learning_goal or '' }}</textarea>
        </div>
    </div>

    <div class="form-section">
        <h2>Progress</h2>

        <div class="form-group">
            <label for="progress">Completion (<span id="progress-value">{{ form_data.progress|default(0) }}</span>%)</label>
            <input
                type="range"
                id="progress"
                name="progress"
                min="0"
                max="100"
                step="5"
                value="{{ form_data.progress|default(0) }}"
                class="form-control progress-slider"
                oninput="document.getElementById('progress-value').textContent = this.value"
            >
            <div class="progress-bar-preview">
                <div class="progress-bar-fill" id="progress-bar-preview-fill" style="width: {{ form_data.progress|default(0) }}%"></div>
            </div>
        </div>
    </div>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Create Project</button>
        <a href="/projects" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<script>
// Client-side validation for URL field
document.getElementById('repo_url').addEventListener('blur', function() {
    const url = this.value.trim();
    if (url && !(url.startsWith('http://') || url.startsWith('https://') || url.startsWith('git@'))) {
        this.setCustomValidity('Repository URL must start with http://, https://, or git@');
    } else {
        this.setCustomValidity('');
    }
});

// Clear validation on input
document.getElementById('repo_url').addEventListener('input', function() {
    this.setCustomValidity('');
});

// Progress slider preview
document.getElementById('progress').addEventListener('input', function() {
    document.getElementById('progress-bar-preview-fill').style.width = this.value + '%';
});

// ========================
// Template Picker
// ========================
(function() {
    const apiBase = '{{ api_base_url }}';
    const templateSelect = document.getElementById('template-select');
    const applyBtn = document.getElementById('apply-template-btn');
    const descEl = document.getElementById('template-description');
    let allTemplates = [];

    async function loadTemplates() {
        try {
            const resp = await fetch(`${apiBase}/api/templates`);
            if (!resp.ok) return;
            const data = await resp.json();
            allTemplates = data.templates || [];
            allTemplates.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.textContent = t.name;
                templateSelect.appendChild(opt);
            });

            // Auto-apply if coming from "Use This Template" on the templates page
            const pendingId = localStorage.getItem('applyTemplate');
            if (pendingId) {
                localStorage.removeItem('applyTemplate');
                templateSelect.value = pendingId;
                templateSelect.dispatchEvent(new Event('change'));
                applyBtn.click();
            }
        } catch (e) { /* silently fail */ }
    }

    templateSelect.addEventListener('change', () => {
        const id = parseInt(templateSelect.value);
        const tpl = allTemplates.find(t => t.id === id);
        applyBtn.disabled = !tpl;
        if (tpl && tpl.description) {
            descEl.textContent = tpl.description;
            descEl.style.display = 'block';
        } else {
            descEl.style.display = 'none';
        }
    });

    applyBtn.addEventListener('click', () => {
        const id = parseInt(templateSelect.value);
        const tpl = allTemplates.find(t => t.id === id);
        if (!tpl) return;

        const setVal = (id, val) => {
            const el = document.getElementById(id);
            if (el && val != null && val !== '') el.value = val;
        };
        const setSelect = (id, val) => {
            const el = document.getElementById(id);
            if (el && val) {
                const opt = Array.from(el.options).find(o => o.value === val);
                if (opt) el.value = val;
            }
        };

        setSelect('status', tpl.default_status);
        setSelect('project_type', tpl.default_project_type);
        setVal('primary_language', tpl.default_primary_language);
        setVal('stack', tpl.default_stack);
        setSelect('scope_size', tpl.default_scope_size);
        setVal('learning_goal', tpl.default_learning_goal);

        // Show visual feedback
        applyBtn.textContent = '‚úì Applied!';
        applyBtn.classList.add('btn-primary');
        applyBtn.classList.remove('btn-secondary');
        setTimeout(() => {
            applyBtn.textContent = 'Apply Template';
            applyBtn.classList.remove('btn-primary');
            applyBtn.classList.add('btn-secondary');
        }, 2000);
    });

    loadTemplates();
})();
</script>
{% endblock %}
