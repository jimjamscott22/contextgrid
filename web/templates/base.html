<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ContextGrid{% endblock %}</title>
    <script>
        (() => {
            let stored = null;
            try {
                stored = localStorage.getItem("cg-theme");
            } catch (error) {
                stored = null;
            }

            if (stored === "dark" || stored === "light") {
                document.documentElement.setAttribute("data-theme", stored);
                return;
            }

            if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
                document.documentElement.setAttribute("data-theme", "dark");
            }
        })();
    </script>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <button
                    type="button"
                    id="sidebar-toggle"
                    class="btn btn-secondary btn-compact sidebar-toggle"
                    aria-label="Toggle sidebar"
                    title="Toggle sidebar"
                >â˜°</button>
                <a href="/">ðŸ“¦ ContextGrid</a>
            </div>
            <div class="nav-actions">
                <ul class="nav-links">
                    <li><a href="/">Home</a></li>
                    <li><a href="/projects">Projects</a></li>
                    <li><a href="/kanban">Kanban</a></li>
                    <li><a href="/graph">Graph</a></li>
                    <li><a href="/tags">Tags</a></li>
                </ul>
                <button
                    type="button"
                    id="theme-toggle"
                    class="btn btn-secondary btn-compact theme-toggle"
                    aria-label="Switch to dark mode"
                    title="Switch to dark mode"
                >ðŸŒ™</button>
            </div>
        </div>
    </nav>

    <!-- Sidebar Overlay (for mobile) -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h3>Projects</h3>
            <button
                type="button"
                id="sidebar-close"
                class="btn btn-secondary btn-compact"
                aria-label="Close sidebar"
                title="Close sidebar"
            >âœ•</button>
        </div>

        <div class="sidebar-search">
            <input
                type="text"
                id="sidebar-search-input"
                class="sidebar-search-input"
                placeholder="Search projects..."
            >
        </div>

        <div class="sidebar-content" id="sidebar-projects">
            <div class="sidebar-loading">Loading projects...</div>
        </div>
    </aside>

    <div class="page-wrapper">
        <main class="container">
            {% block content %}{% endblock %}
        </main>
    </div>

    <footer class="footer">
        <div class="container">
            <p>ContextGrid - Track what you're building, where it lives, and what's next.</p>
        </div>
    </footer>
    <script>
        (() => {
            const toggle = document.getElementById("theme-toggle");
            if (!toggle) {
                return;
            }

            let storage = null;
            try {
                storage = localStorage;
            } catch (error) {
                storage = null;
            }

            const getStoredTheme = () => (storage ? storage.getItem("cg-theme") : null);
            const setStoredTheme = (value) => {
                if (storage) {
                    storage.setItem("cg-theme", value);
                }
            };

            const setTheme = (theme) => {
                document.documentElement.setAttribute("data-theme", theme);
                if (document.body) {
                    document.body.setAttribute("data-theme", theme);
                }
            };

            const getTheme = () => document.documentElement.getAttribute("data-theme") || "light";
            const updateToggle = (theme) => {
                if (theme === "dark") {
                    toggle.textContent = "â˜€ï¸";
                    toggle.setAttribute("aria-label", "Switch to light mode");
                    toggle.title = "Switch to light mode";
                } else {
                    toggle.textContent = "ðŸŒ™";
                    toggle.setAttribute("aria-label", "Switch to dark mode");
                    toggle.title = "Switch to dark mode";
                }
            };

            setTheme(getTheme());
            updateToggle(getTheme());

            toggle.addEventListener("click", () => {
                const next = getTheme() === "dark" ? "light" : "dark";
                setTheme(next);
                setStoredTheme(next);
                updateToggle(next);
            });

            if (window.matchMedia) {
                const media = window.matchMedia("(prefers-color-scheme: dark)");
                if (media.addEventListener) {
                    media.addEventListener("change", (event) => {
                        const stored = getStoredTheme();
                        if (stored === "dark" || stored === "light") {
                            return;
                        }
                        const theme = event.matches ? "dark" : "light";
                        setTheme(theme);
                        updateToggle(theme);
                    });
                }
            }
        })();
    </script>
    <script>
        (() => {
            // Sidebar functionality
            const sidebar = document.getElementById("sidebar");
            const sidebarToggle = document.getElementById("sidebar-toggle");
            const sidebarClose = document.getElementById("sidebar-close");
            const sidebarOverlay = document.getElementById("sidebar-overlay");
            const sidebarContent = document.getElementById("sidebar-projects");
            const searchInput = document.getElementById("sidebar-search-input");

            if (!sidebar || !sidebarToggle) return;

            let storage = null;
            try {
                storage = localStorage;
            } catch (error) {
                storage = null;
            }

            let allProjects = [];
            let filteredProjects = [];

            // Get/set sidebar state
            const getSidebarState = () => (storage ? storage.getItem("cg-sidebar") : null);
            const setSidebarState = (state) => {
                if (storage) storage.setItem("cg-sidebar", state);
            };

            // Toggle sidebar
            const openSidebar = () => {
                sidebar.classList.add("sidebar-open");
                sidebarOverlay.classList.add("active");
                document.body.style.overflow = "hidden";
                setSidebarState("open");
            };

            const closeSidebar = () => {
                sidebar.classList.remove("sidebar-open");
                sidebarOverlay.classList.remove("active");
                document.body.style.overflow = "";
                setSidebarState("closed");
            };

            const toggleSidebar = () => {
                if (sidebar.classList.contains("sidebar-open")) {
                    closeSidebar();
                } else {
                    openSidebar();
                }
            };

            // Event listeners
            sidebarToggle.addEventListener("click", toggleSidebar);
            if (sidebarClose) sidebarClose.addEventListener("click", closeSidebar);
            sidebarOverlay.addEventListener("click", closeSidebar);

            // Close sidebar on ESC key
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape" && sidebar.classList.contains("sidebar-open")) {
                    closeSidebar();
                }
            });

            // Restore sidebar state on desktop
            const restoreSidebarState = () => {
                if (window.innerWidth >= 1024) {
                    const state = getSidebarState();
                    if (state === "open" || state === null) {
                        sidebar.classList.add("sidebar-open");
                        document.body.style.overflow = "";
                    }
                }
            };

            // Fetch and render projects
            const fetchProjects = async () => {
                try {
                    const response = await fetch("{{ api_base_url }}/api/projects?limit=100&sort_by=last_worked_at&sort_order=desc");
                    if (!response.ok) throw new Error("Failed to fetch projects");

                    const data = await response.json();
                    allProjects = data.projects || [];
                    filteredProjects = [...allProjects];
                    renderProjects();
                } catch (error) {
                    console.error("Error fetching projects:", error);
                    sidebarContent.innerHTML = '<div class="sidebar-error">Failed to load projects</div>';
                }
            };

            // Group projects by status
            const groupByStatus = (projects) => {
                const groups = {
                    active: [],
                    idea: [],
                    paused: [],
                    archived: []
                };

                projects.forEach(project => {
                    const status = project.status || "idea";
                    if (groups[status]) {
                        groups[status].push(project);
                    }
                });

                return groups;
            };

            // Render projects in sidebar
            const renderProjects = () => {
                if (filteredProjects.length === 0) {
                    sidebarContent.innerHTML = '<div class="sidebar-empty">No projects found</div>';
                    return;
                }

                const grouped = groupByStatus(filteredProjects);
                let html = '';

                const statusOrder = ['active', 'idea', 'paused', 'archived'];
                const statusLabels = {
                    active: 'Active',
                    idea: 'Ideas',
                    paused: 'Paused',
                    archived: 'Archived'
                };

                statusOrder.forEach(status => {
                    const projects = grouped[status];
                    if (projects.length > 0) {
                        html += `
                            <div class="sidebar-group">
                                <div class="sidebar-group-header">
                                    <span class="sidebar-group-title">${statusLabels[status]}</span>
                                    <span class="sidebar-group-count">${projects.length}</span>
                                </div>
                                <ul class="sidebar-project-list">
                        `;

                        projects.forEach(project => {
                            const lastViewed = project.last_worked_at
                                ? `Last viewed: ${new Date(project.last_worked_at).toLocaleDateString()}`
                                : 'Last viewed: Never';

                            html += `
                                <li class="sidebar-project-item">
                                    <a href="/projects/${project.id}" class="sidebar-project-link">
                                        <span class="sidebar-project-name">${escapeHtml(project.name)}</span>
                                        <span class="sidebar-project-meta">${lastViewed}</span>
                                    </a>
                                </li>
                            `;
                        });

                        html += `
                                </ul>
                            </div>
                        `;
                    }
                });

                sidebarContent.innerHTML = html;
            };

            // Search functionality
            const filterProjects = (query) => {
                if (!query.trim()) {
                    filteredProjects = [...allProjects];
                } else {
                    const lowerQuery = query.toLowerCase();
                    filteredProjects = allProjects.filter(project =>
                        project.name.toLowerCase().includes(lowerQuery) ||
                        (project.description && project.description.toLowerCase().includes(lowerQuery))
                    );
                }
                renderProjects();
            };

            // Debounce search input
            let searchTimeout;
            if (searchInput) {
                searchInput.addEventListener("input", (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        filterProjects(e.target.value);
                    }, 300);
                });
            }

            // HTML escape utility
            const escapeHtml = (text) => {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };

            // Handle window resize
            let resizeTimeout;
            window.addEventListener("resize", () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    if (window.innerWidth >= 1024) {
                        sidebarOverlay.classList.remove("active");
                        document.body.style.overflow = "";
                    } else {
                        if (sidebar.classList.contains("sidebar-open")) {
                            sidebarOverlay.classList.add("active");
                            document.body.style.overflow = "hidden";
                        }
                    }
                }, 100);
            });

            // Initialize
            restoreSidebarState();
            fetchProjects();
        })();
    </script>
</body>
</html>
