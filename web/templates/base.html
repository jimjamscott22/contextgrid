<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ContextGrid{% endblock %}</title>
    <script>
        (() => {
            let stored = null;
            try {
                stored = localStorage.getItem("cg-theme");
            } catch (error) {
                stored = null;
            }

            if (stored === "dark" || stored === "light") {
                document.documentElement.setAttribute("data-theme", stored);
                return;
            }

            if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
                document.documentElement.setAttribute("data-theme", "dark");
            }
        })();
    </script>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <a href="/">ðŸ“¦ ContextGrid</a>
            </div>
            <div class="nav-actions">
                <ul class="nav-links">
                    <li><a href="/">Home</a></li>
                    <li><a href="/projects">Projects</a></li>
                    <li><a href="/tags">Tags</a></li>
                </ul>
                <button
                    type="button"
                    id="theme-toggle"
                    class="btn btn-secondary btn-compact theme-toggle"
                    aria-label="Switch to dark mode"
                    title="Switch to dark mode"
                >ðŸŒ™</button>
            </div>
        </div>
    </nav>

    <main class="container">
        {% block content %}{% endblock %}
    </main>

    <footer class="footer">
        <div class="container">
            <p>ContextGrid - Track what you're building, where it lives, and what's next.</p>
        </div>
    </footer>
    <script>
        (() => {
            const toggle = document.getElementById("theme-toggle");
            if (!toggle) {
                return;
            }

            let storage = null;
            try {
                storage = localStorage;
            } catch (error) {
                storage = null;
            }

            const getStoredTheme = () => (storage ? storage.getItem("cg-theme") : null);
            const setStoredTheme = (value) => {
                if (storage) {
                    storage.setItem("cg-theme", value);
                }
            };

            const setTheme = (theme) => {
                document.documentElement.setAttribute("data-theme", theme);
                if (document.body) {
                    document.body.setAttribute("data-theme", theme);
                }
            };

            const getTheme = () => document.documentElement.getAttribute("data-theme") || "light";
            const updateToggle = (theme) => {
                if (theme === "dark") {
                    toggle.textContent = "â˜€ï¸";
                    toggle.setAttribute("aria-label", "Switch to light mode");
                    toggle.title = "Switch to light mode";
                } else {
                    toggle.textContent = "ðŸŒ™";
                    toggle.setAttribute("aria-label", "Switch to dark mode");
                    toggle.title = "Switch to dark mode";
                }
            };

            setTheme(getTheme());
            updateToggle(getTheme());

            toggle.addEventListener("click", () => {
                const next = getTheme() === "dark" ? "light" : "dark";
                setTheme(next);
                setStoredTheme(next);
                updateToggle(next);
            });

            if (window.matchMedia) {
                const media = window.matchMedia("(prefers-color-scheme: dark)");
                if (media.addEventListener) {
                    media.addEventListener("change", (event) => {
                        const stored = getStoredTheme();
                        if (stored === "dark" || stored === "light") {
                            return;
                        }
                        const theme = event.matches ? "dark" : "light";
                        setTheme(theme);
                        updateToggle(theme);
                    });
                }
            }
        })();
    </script>
</body>
</html>
